
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="https://unonibes4a.github.io/pintaresta/min.ico">  
    <title>Pintaresta</title>






<script src="https://evanw.github.io/glfx.js/glfx.js"></script>
  
  <style>
    .aps {
      position: fixed;
      top: 0%;
      left: 0%;
      width: 100%;
      height: 100%;
      z-index: 1000000090;
      background-color: #080e08be;

    }

    

    ::-webkit-scrollbar {
      width: 10px;
    }


    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }


    ::-webkit-scrollbar-thumb {
      background: #888;
    }


    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .giodefaultimgeditor-classlesfttextR {
      margin-top: 6rem;
      position: relative;
      right: 2%;
      top: 3%;
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: flex-start;
      align-items: stretch;
      align-content: stretch;
      font-size: 12px;
      color: #fff;
    }

    .giodefaultimgeditor-upload-btn-primary:hover {

      color: #5587dd;
      font-size: 14px;
    }

    .giodefaultimgeditor-upload-btn-secondary:hover {
      font-size: 15px;
      color: #5587dd;
    }

    .giodefaultimgeditor-classlesfttext {
      position: absolute;
      right: 2%;
      top: 2%;
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: flex-start;
      align-items: stretch;
      align-content: stretch;
      font-size: 14px;
      color: #fff;
    }

    .giodefaultimgeditor-app-container {
      position: relative;
      width: 100%;
      min-height: 100vh;
      display: flex;
    }

    .giodefaultimgeditor-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 320px;
      height: 100vh;
      background: rgba(19, 19, 19, 0.863);
      backdrop-filter: blur(20px);
      overflow-y: auto;
      padding: 24px;
      z-index: 100;
      transform: translateX(0);
      transition: transform 0.3s ease-in-out;
    }

    .giodefaultimgeditor-sidebar.hidden {
      transform: translateX(-100%);
    }

    .giodefaultimgeditor-sidebar-header {
      margin-bottom: 32px;
    }

    .giodefaultimgeditor-sidebar-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .giodefaultimgeditor-sidebar-subtitle {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
    }

    .giodefaultimgeditor-upload-section {
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .giodefaultimgeditor-upload-btn {
      width: 100%;
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 12px;
    }

    .giodefaultimgeditor-upload-btn-primary {
      background: #252525;
      color: #fff;
    }

    .giodefaultimgeditor-upload-btn-secondary {
      background: #252525;
      color: #fff;
    }

    .giodefaultimgeditor-upload-info {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
      text-align: center;
      margin-top: 8px;
    }

    .giodefaultimgeditor-filters-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .giodefaultimgeditor-filter-section {
      margin-bottom: 16px;
    }

    .giodefaultimgeditor-filter-toggle-btn {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.08);
      border: 2px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
    }

    .giodefaultimgeditor-filter-toggle-btn.giodefaultimgeditor-active {
      background: rgba(59, 130, 246, 0.25);
      border-color: #32476a;
    }

    .giodefaultimgeditor-filter-controls {
      margin-top: 12px;
      padding: 16px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      display: none;
    }

    .giodefaultimgeditor-filter-select-wrapper {
      margin-bottom: 16px;
    }

    .giodefaultimgeditor-filter-select-label {
      display: block;
      margin-bottom: 8px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
    }

    .giodefaultimgeditor-filter-select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      font-size: 13px;
      cursor: pointer;
      outline: none;
    }

    .giodefaultimgeditor-filter-select option {
      background: #1f2937;
      color: #fff;
    }

    .giodefaultimgeditor-control-group {
      background: rgba(255, 255, 255, 0.05);
      padding: 14px;
      border-radius: 10px;
      margin-bottom: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .giodefaultimgeditor-control-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 12px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
    }

    .giodefaultimgeditor-value-display {
      background: rgba(59, 130, 246, 0.3);
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 11px;
      color: #60a5fa;
      font-weight: 600;
    }

    .giodefaultimgeditor-range-input {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.1);
      outline: none;
      -webkit-appearance: none;
    }

    .giodefaultimgeditor-range-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #32476a;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.5);
    }

    .giodefaultimgeditor-range-input::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #32476a;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.5);
    }

    .giodefaultimgeditor-main-content {
      flex-grow: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 40px;
      margin-left: 320px;
      transition: margin-left 0.3s ease-in-out;
    }

    .giodefaultimgeditor-main-content.sidebar-hidden {
      margin-left: 0;
    }

    .giodefaultimgeditor-canvas-wrapper {
      position: relative;
      max-width: 100%;
      max-height: calc(100vh - 80px);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .giodefaultimgeditor-canvas {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      background: #fff;
    }

    .giodefaultimgeditor-drop-zone {
      position: none;
      top: 0;
      left: 0;
      width: 0%;
      height: 0%;
      background: rgba(59, 131, 246, 0);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      backdrop-filter: blur(10px);
      z-index: -100;
    }

    .giodefaultimgeditor-drop-zone.giodefaultimgeditor-active {
      display: none;
    }

    .giodefaultimgeditor-drop-message {
      font-size: 32px;
      font-weight: 700;
      color: #fff;
      text-align: center;
      padding: 60px;
      border: 4px dashed #fff;
      border-radius: 24px;
    }

    .giodefaultimgeditor-file-input {
      display: none;
    }

    .giodefaultimgeditor-hamburger-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 40px;
      height: 40px;
      background: #32476a;
      border: none;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      align-items: center;
      padding: 8px;
      cursor: pointer;
      z-index: 101;
      transition: background 0.3s ease;
    }

    .giodefaultimgeditor-hamburger-btn span {
      display: block;
      width: 24px;
      height: 2px;
      background: #fff;
      border-radius: 1px;
      transition: all 0.3s ease;
    }

    .giodefaultimgeditor-hamburger-btn.active span:nth-child(1) {
      transform: translateY(7px) rotate(45deg);
    }

    .giodefaultimgeditor-hamburger-btn.active span:nth-child(2) {
      opacity: 0;
    }

    .giodefaultimgeditor-hamburger-btn.active span:nth-child(3) {
      transform: translateY(-7px) rotate(-45deg);
    }

    @media screen and (max-width: 768px) {
      .giodefaultimgeditor-sidebar {
        width: 280px;
        padding: 16px;
      }

      .giodefaultimgeditor-main-content {
        margin-left: 0;
        padding: 20px;
        width: 100%;
        height: 100%;
        min-width: unset;
        min-height: unset;
      }

      .giodefaultimgeditor-main-content.sidebar-hidden {
        margin-left: 0;
      }

      .giodefaultimgeditor-canvas {
        max-width: 90%;
        max-height: 80vh;
      }

      .giodefaultimgeditor-hamburger-btn {
        left: 10px;
        top: 10px;
      }
    }
  </style>
 
  <div id="idSoporteApp" class="aps" style="width: 100%; height: 100%;"></div>

  <script>
    document.addEventListener('keydown', event => {
      const soporteApp = document.getElementById('idSoporteApp');
      const soporteApp2 = document.getElementById('idSoporteApp2');

      if (event.key === 'a' || event.key === 'A') {
        soporteApp.style.display = soporteApp.style.display === 'none' ? 'block' : 'none';
      } else if (event.key === 's' || event.key === 'S') {
        soporteApp2.style.display = soporteApp2.style.display === 'none' ? 'block' : 'none';
      }
    });
  </script>
  <script> 
class GioUISliderBasico {
  constructor(parentHtml, min, max, eventos, idGenerico, labelText, initialValue = 5, step = 1) {
    this.id = `${idGenerico}_slider`;
    this.idLabel = `${idGenerico}_label`;
    this.idValue = `${idGenerico}_value`;
    this.idInput = `${idGenerico}_input`;
    this.min = min;
    this.max = max;
    this.eventos = eventos;
    this.labelText = labelText;
    this.initialValue = initialValue;
    this.step = step;

    const sliderHTML = `
      <div class="giodefaultimgeditor-control-label">
        <span id="${this.idLabel}">${this.labelText}</span>
        <span class="giodefaultimgeditor-value-display" id="${this.idValue}">${this.initialValue}</span>
      </div>
      <input type="range" class="giodefaultimgeditor-range-input" id="${this.idInput}" min="${this.min}" max="${this.max}" step="${this.step}" value="${this.initialValue}">
    `;

    this.controlGroup = document.createElement('div');
    this.controlGroup.classList.add('giodefaultimgeditor-control-group');
    this.controlGroup.id = this.id;
    this.controlGroup.innerHTML = sliderHTML;

    parentHtml.appendChild(this.controlGroup);

    this.spanText = this.controlGroup.querySelector(`#${this.idLabel}`);
    this.spanValue = this.controlGroup.querySelector(`#${this.idValue}`);
    this.inputRange = this.controlGroup.querySelector(`#${this.idInput}`);

    this.inputRange.addEventListener('input', this.handleInput.bind(this));

    if (this.eventos?.onChange instanceof Function) {
      this.inputRange.addEventListener('input', this.eventos.onChange);
    }
  }

  handleInput(event) {
    this.spanValue.textContent = event.target.value;
  }

  getValue() {
    return parseFloat(this.inputRange.value);
  }

  setValue(value) {
    this.inputRange.value = value;
    this.spanValue.textContent = value;
  }

  destroy() {
    this.controlGroup?.parentNode?.removeChild(this.controlGroup);
  }
}

class ImageLoader {
  constructor(callbacks, idPrefix) {
    this.prefix = idPrefix;
    this.idFileInput = `${this.prefix}_file_input`;
    this.idUploadBtn = `${this.prefix}_upload_btn`;
    this.idPasteBtn = `${this.prefix}_paste_btn`;
    this.idDropZone = `${this.prefix}_drop_zone`;
    this.callbacks = callbacks;
    this.originalImage = null;
  }

  init() {
    this._initFileInput();
    this._initDragDrop();
    this._initPasteFromClipboard();
  }

  _initFileInput() {
    const fileInput = document.getElementById(this.idFileInput);
    const uploadBtn = document.getElementById(this.idUploadBtn);
    const pasteBtn = document.getElementById(this.idPasteBtn);

    uploadBtn?.addEventListener('click', () => fileInput?.click());
    fileInput?.addEventListener('change', e => this._handleImageUpload(e));
    pasteBtn?.addEventListener('click', () => this._pasteFromClipboard());
  }

  _initDragDrop() {
    const dropZone = document.getElementById(this.idDropZone);
    const body = document.body;

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      body.addEventListener(eventName, e => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      body.addEventListener(eventName, () => {
        dropZone?.classList.add('giodefaultimgeditor-active');
      });
    });

    ['dragleave', 'drop'].forEach(eventName => {
      body.addEventListener(eventName, () => {
        dropZone?.classList.remove('giodefaultimgeditor-active');
      });
    });

    body.addEventListener('drop', e => {
      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].type.startsWith('image/')) {
        this._loadImageFromFile(files[0]);
      }
    });
  }

  _initPasteFromClipboard() {
    document.addEventListener('paste', e => this._handlePaste(e));
  }

  async _handlePaste(e) {
    const items = e.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
      if (items[i].type.indexOf('image') !== -1) {
        const blob = items[i].getAsFile();
        this._loadImageFromFile(blob);
        break;
      }
    }
  }

  async _pasteFromClipboard() {
    try {
      const clipboardItems = await navigator.clipboard.read();
      for (const item of clipboardItems) {
        for (const type of item.types) {
          if (type.startsWith('image/')) {
            const blob = await item.getType(type);
            this._loadImageFromFile(blob);
            return;
          }
        }
      }
      alert('No se encontro ninguna imagen en el portapapeles');
    } catch (err) {
      alert('No se pudo acceder al portapapeles. Usa Ctrl+V para pegar.');
    }
  }

  _handleImageUpload(e) {
    const file = e.target.files[0];
    if (file) {
      this._loadImageFromFile(file);
    }
  }

  _loadImageFromFile(file) {
    const reader = new FileReader();
    reader.onload = event => {
      const img = new Image();
      img.onload = () => {
        this.originalImage = img;
        this.callbacks.onImageLoad?.(img);
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  }

  getOriginalImage() {
    return this.originalImage;
  }
}

class CarbonDrawingFilter {
  constructor(canvas, onUpdate, idPrefix) {
    this.prefix = idPrefix;
    this.idSection = `${this.prefix}_carbon_sect`;
    this.idToggleBtn = `${this.prefix}_carbon_toggle_btn`;
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d', { willReadFrequently: true });
    this.onUpdate = onUpdate;
    this.controls = {};
    this.isActive = false;
    this.controlsContainer = null;
  }

  createUI(parentElement) {
    const section = document.createElement('div');
    section.id = this.idSection;
    section.className = 'giodefaultimgeditor-filter-section';
    section.innerHTML = `
      <button class="giodefaultimgeditor-filter-toggle-btn" id="${this.idToggleBtn}">
        Dibujo a Carbon
      </button>
      <div class="giodefaultimgeditor-filter-controls" id="${this.prefix}_carbon_controls">
      </div>
    `;
    parentElement.appendChild(section);
    this.controlsContainer = document.getElementById(`${this.prefix}_carbon_controls`);
    document.getElementById(this.idToggleBtn).addEventListener('click', () => this.toggle());
    this._createControls();
  }

  _createControls() {
    const onChange = () => this.isActive && this.onUpdate?.();

    this.controls.carbonIntensity = new GioUISliderBasico(
      this.controlsContainer, -10, 100, { onChange },
      `${this.prefix}_carbon_intensity`, 'Coal Intensity', 10, 1
    );

    this.controls.strokeWidth = new GioUISliderBasico(
      this.controlsContainer, -10, 100, { onChange },
      `${this.prefix}_carbon_stroke`, 'Stroke Thickness', 7, 1
    );

    this.controls.contrast = new GioUISliderBasico(
      this.controlsContainer, -100, 100, { onChange },
      `${this.prefix}_carbon_contrast`, 'Contrast', 1, 1
    );

    this.controls.depth3D = new GioUISliderBasico(
      this.controlsContainer, -160, 100, { onChange },
      `${this.prefix}_carbon_depth`, '3D Depth', 7, 1
    );

    this.controls.paperTexture = new GioUISliderBasico(
      this.controlsContainer, -100, 100, { onChange },
      `${this.prefix}_carbon_texture`, 'Paper Texture', -70, 1
    );

    this.controls.smoothing = new GioUISliderBasico(
      this.controlsContainer, 0, 10, { onChange },
      `${this.prefix}_carbon_smooth`, 'Softening', 3, 1
    );
  }

  toggle() {
    this.isActive = !this.isActive;
    if (this.controlsContainer) {
      this.controlsContainer.style.display = this.isActive ? 'block' : 'none';
    }
    const btn = document.getElementById(this.idToggleBtn);
    btn?.classList.toggle('giodefaultimgeditor-active', this.isActive);
    this.onUpdate?.();
  }

  applyFilter(imageData) {
    if (!this.isActive) return imageData;

    const carbon = this.controls.carbonIntensity.getValue();
    const stroke = this.controls.strokeWidth.getValue();
    const contrast = this.controls.contrast.getValue();
    const depth = this.controls.depth3D.getValue();
    const texture = this.controls.paperTexture.getValue();
    const smooth = this.controls.smoothing.getValue();

    let result = imageData;

    if (texture > 0) {
      result = this._applyPaperTexture(result, texture);
    }

    result = this._toGrayscaleWithContrast(result, contrast);

    if (smooth > 0) {
      result = this._gaussianBlur(result, smooth);
    }

    const edges = this._enhancedSobelDetection(result, stroke);
    const depthMap = this._createDepthMap(result, depth);
    const volumeData = this._apply3DVolume(edges, depthMap, depth);
    var finalData = this._applyCarbonTexture(volumeData, carbon, stroke);

    finalData = this.faicolor(finalData);

    return finalData;
  }

  faicolor = (imageData) => {
    let data = imageData.data;
    let rgba = { r: 0, g: 0, b: 0 };

    for (let i = 0; i < data.length; i += 4) {
      rgba.r = data[i] / 255;
      rgba.g = data[i + 1] / 255;
      rgba.b = data[i + 2] / 255;

      let maxpx2 = Math.max(rgba.r, rgba.g, rgba.b);
      let minx2 = Math.min(rgba.r, rgba.g, rgba.b);
      let dv2 = minx2 / (maxpx2 + 0.00001);

      this.operacionMatematica(rgba, maxpx2 * maxpx2, "*");
      this.operacionMatematica(rgba, maxpx2 * maxpx2, "*");
      this.operacionMatematica(rgba, 0.5, "pow");

      data[i] = rgba.r * 255;
      data[i + 1] = rgba.g * 255;
      data[i + 2] = rgba.b * 255;
    }
    return imageData;
  }

  operacionMatematica = (rgba, val, operacion) => {
    const value1o0 = v => Math.max(0, Math.min(1, v));

    switch (operacion) {
      case "multiplicar":
      case "*":
        rgba.r *= val; rgba.r = value1o0(rgba.r);
        rgba.g *= val; rgba.g = value1o0(rgba.g);
        rgba.b *= val; rgba.b = value1o0(rgba.b);
        break;
      case "+":
        rgba.r += val; rgba.r = value1o0(rgba.r);
        rgba.g += val; rgba.g = value1o0(rgba.g);
        rgba.b += val; rgba.b = value1o0(rgba.b);
        break;
      case "potencia":
      case "pow":
        rgba.r = Math.pow(rgba.r, val); rgba.r = value1o0(rgba.r);
        rgba.g = Math.pow(rgba.g, val); rgba.g = value1o0(rgba.g);
        rgba.b = Math.pow(rgba.b, val); rgba.b = value1o0(rgba.b);
        break;
      case "asigna":
      case "=":
        rgba.r = val.r; rgba.r = value1o0(rgba.r);
        rgba.g = val.g; rgba.g = value1o0(rgba.g);
        rgba.b = val.b; rgba.b = value1o0(rgba.b);
        break;
      case "srgba":
        rgba.r += rgba.r; rgba.r = value1o0(rgba.r);
        rgba.g += rgba.g; rgba.g = value1o0(rgba.g);
        rgba.b += rgba.b; rgba.b = value1o0(rgba.b);
        break;
    }
    return rgba;
  }

  _applyPaperTexture(imageData, intensity) {
    const data = new Uint8ClampedArray(imageData.data);
    const noise = intensity / 10;
    for (let i = 0; i < data.length; i += 4) {
      const random = (Math.random() - 0.5) * noise * 20;
      data[i] = Math.max(0, Math.min(255, data[i] + random));
      data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + random));
      data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + random));
    }
    return new ImageData(data, imageData.width, imageData.height);
  }

  _toGrayscaleWithContrast(imageData, contrastLevel) {
    const data = new Uint8ClampedArray(imageData.data);
    const factor = (259 * (contrastLevel * 25.5 + 255)) / (255 * (259 - contrastLevel * 25.5));
    for (let i = 0; i < data.length; i += 4) {
      const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
      const contrasted = factor * (gray - 128) + 128;
      const final = Math.max(0, Math.min(255, contrasted));
      data[i] = data[i + 1] = data[i + 2] = final;
    }
    return new ImageData(data, imageData.width, imageData.height);
  }

  _gaussianBlur(imageData, radius) {
    const width = imageData.width;
    const height = imageData.height;
    const data = imageData.data;
    const output = this.ctx.createImageData(width, height);
    const outputData = output.data;
    const sigma = radius / 3;
    const kernel = this._createGaussianKernel(radius, sigma);
    const kernelSize = kernel.length;
    const half = Math.floor(kernelSize / 2);

    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        let sum = 0;
        let weightSum = 0;
        for (let ky = -half; ky <= half; ky++) {
          for (let kx = -half; kx <= half; kx++) {
            const px = Math.min(Math.max(x + kx, 0), width - 1);
            const py = Math.min(Math.max(y + ky, 0), height - 1);
            const idx = (py * width + px) * 4;
            const weight = kernel[ky + half][kx + half];
            sum += data[idx] * weight;
            weightSum += weight;
          }
        }
        const idx = (y * width + x) * 4;
        const value = sum / weightSum;
        outputData[idx] = outputData[idx + 1] = outputData[idx + 2] = value;
        outputData[idx + 3] = 255;
      }
    }
    return output;
  }

  _createGaussianKernel(radius, sigma) {
    const size = radius * 2 + 1;
    const kernel = Array(size).fill(0).map(() => Array(size).fill(0));
    let sum = 0;
    for (let y = -radius; y <= radius; y++) {
      for (let x = -radius; x <= radius; x++) {
        const value = Math.exp(-(x * x + y * y) / (2 * sigma * sigma));
        kernel[y + radius][x + radius] = value;
        sum += value;
      }
    }
    for (let y = 0; y < size; y++) {
      for (let x = 0; x < size; x++) {
        kernel[y][x] /= sum;
      }
    }
    return kernel;
  }

  _enhancedSobelDetection(imageData, edgeStrength) {
    const width = imageData.width;
    const height = imageData.height;
    const data = imageData.data;
    const output = this.ctx.createImageData(width, height);
    const outputData = output.data;
    const sobelX = [-1, 0, 1, -2, 0, 2, -1, 0, 1];
    const sobelY = [-1, -2, -1, 0, 0, 0, 1, 2, 1];

    for (let y = 1; y < height - 1; y++) {
      for (let x = 1; x < width - 1; x++) {
        let gx = 0, gy = 0;
        for (let ky = -1; ky <= 1; ky++) {
          for (let kx = -1; kx <= 1; kx++) {
            const idx = ((y + ky) * width + (x + kx)) * 4;
            const gray = data[idx];
            const kernelIdx = (ky + 1) * 3 + (kx + 1);
            gx += gray * sobelX[kernelIdx];
            gy += gray * sobelY[kernelIdx];
          }
        }
        const magnitude = Math.sqrt(gx * gx + gy * gy);
        const enhanced = Math.min(255, magnitude * edgeStrength / 3);
        const idx = (y * width + x) * 4;
        outputData[idx] = outputData[idx + 1] = outputData[idx + 2] = enhanced;
        outputData[idx + 3] = 255;
      }
    }
    return output;
  }

  _createDepthMap(imageData, depthLevel) {
    const width = imageData.width;
    const height = imageData.height;
    const data = imageData.data;
    const depthMap = this.ctx.createImageData(width, height);
    const depthData = depthMap.data;

    for (let y = 1; y < height - 1; y++) {
      for (let x = 1; x < width - 1; x++) {
        const idx = (y * width + x) * 4;
        const center = data[idx];
        let gradient = 0;
        for (let dy = -1; dy <= 1; dy++) {
          for (let dx = -1; dx <= 1; dx++) {
            const nIdx = ((y + dy) * width + (x + dx)) * 4;
            gradient += Math.abs(data[nIdx] - center);
          }
        }
        const depth = Math.min(255, gradient * depthLevel / 5);
        depthData[idx] = depthData[idx + 1] = depthData[idx + 2] = depth;
        depthData[idx + 3] = 255;
      }
    }
    return depthMap;
  }

  _apply3DVolume(edges, depthMap, volumeLevel) {
    const width = edges.width;
    const height = edges.height;
    const edgeData = edges.data;
    const depthData = depthMap.data;
    const output = this.ctx.createImageData(width, height);
    const outputData = output.data;
    const lightAngle = Math.PI / 4;
    const lightX = Math.cos(lightAngle);
    const lightY = Math.sin(lightAngle);

    for (let y = 1; y < height - 1; y++) {
      for (let x = 1; x < width - 1; x++) {
        const idx = (y * width + x) * 4;
        const edge = edgeData[idx];
        const depth = depthData[idx] / 255;
        const idxLeft = (y * width + (x - 1)) * 4;
        const idxRight = (y * width + (x + 1)) * 4;
        const idxUp = ((y - 1) * width + x) * 4;
        const idxDown = ((y + 1) * width + x) * 4;
        const dDepthX = (depthData[idxRight] - depthData[idxLeft]) / 510;
        const dDepthY = (depthData[idxDown] - depthData[idxUp]) / 510;
        const lighting = Math.max(0, lightX * dDepthX + lightY * dDepthY + 0.5);
        const volume = edge * (0.5 + lighting * depth * volumeLevel / 10);
        const final = 255 - Math.min(255, volume);
        outputData[idx] = outputData[idx + 1] = outputData[idx + 2] = final;
        outputData[idx + 3] = 255;
      }
    }
    return output;
  }

  _applyCarbonTexture(imageData, intensity, grain) {
    const data = new Uint8ClampedArray(imageData.data);
    const carbonFactor = intensity / 10;
    for (let i = 0; i < data.length; i += 4) {
      let value = data[i];
      if (value < 200 && Math.random() < grain / 50) {
        const carbonGrain = Math.random() * 30 * carbonFactor;
        value = Math.max(0, value - carbonGrain);
      }
      if (value < 128) {
        value = value * (1 - carbonFactor * 0.3);
      }
      data[i] = data[i + 1] = data[i + 2] = value;
    }
    return new ImageData(data, imageData.width, imageData.height);
  }
}

class EscalaDeGrisFilter {
  constructor(canvas, onUpdate, idPrefix) {
    this.prefix = idPrefix;
    this.idSection = `${this.prefix}_grayscale_sect`;
    this.idToggleBtn = `${this.prefix}_grayscale_toggle_btn`;
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d', { willReadFrequently: true });
    this.onUpdate = onUpdate;
    this.controls = {};
    this.isActive = false;
    this.controlsContainer = null;
  }

  createUI(parentElement) {
    const section = document.createElement('div');
    section.id = this.idSection;
    section.className = 'giodefaultimgeditor-filter-section';
    section.innerHTML = `
      <button class="giodefaultimgeditor-filter-toggle-btn" id="${this.idToggleBtn}">
        Escala de Grises
      </button>
      <div class="giodefaultimgeditor-filter-controls" id="${this.prefix}_grayscale_controls">
      </div>
    `;
    parentElement.appendChild(section);
    this.controlsContainer = document.getElementById(`${this.prefix}_grayscale_controls`);
    document.getElementById(this.idToggleBtn).addEventListener('click', () => this.toggle());
    this._createControls();
  }

  _createControls() {
    const onChange = () => this.isActive && this.onUpdate?.();

    this.controls.intensity = new GioUISliderBasico(
      this.controlsContainer, 0, 100, { onChange },
      `${this.prefix}_grayscale_intensity`, 'Intensidad', 100, 1
    );
  }

  toggle() {
    this.isActive = !this.isActive;
    if (this.controlsContainer) {
      this.controlsContainer.style.display = this.isActive ? 'block' : 'none';
    }
    const btn = document.getElementById(this.idToggleBtn);
    btn?.classList.toggle('giodefaultimgeditor-active', this.isActive);
    this.onUpdate?.();
  }

  applyFilter(imageData) {
    if (!this.isActive) return imageData;

    const intensity = this.controls.intensity.getValue();
    const data = imageData.data;

    for (let i = 0; i < data.length; i += 4) {
      const r = data[i];
      const g = data[i + 1];
      const b = data[i + 2];

      const gray = (r * 0.299 + g * 0.587 + b * 0.114);

      data[i] = r + (gray - r) * (intensity / 100);
      data[i + 1] = g + (gray - g) * (intensity / 100);
      data[i + 2] = b + (gray - b) * (intensity / 100);
    }
    return imageData;
  }
}

class GLFXFilterManager {
  constructor(onUpdate, idPrefix) {
    this.prefix = idPrefix;
    this.idSection = `${this.prefix}_glfx_sect`;
    this.idToggleBtn = `${this.prefix}_glfx_toggle_btn`;
    this.idFilterSelect = `${this.prefix}_glfx_filter_select`;
    this.onUpdate = onUpdate;
    this.isActive = false;
    this.controlsContainer = null;
    this.currentFilterControls = null;
    this.currentFilter = null;
    this.controls = {};
    this.glfxCanvas = null;
    this.glfxTexture = null;
    this.filterDefinitions = {
      'brightnessContrast': {
        name: 'Brightness / Contrast',
        category: 'adjust',
        params: [
          { id: 'brightness', label: 'Brillo', min: -1, max: 1, default: 0, step: 0.01 },
          { id: 'contrast', label: 'Contraste', min: -1, max: 1, default: 0, step: 0.01 }
        ]
      },
      'hueSaturation': {
        name: 'Hue / Saturation',
        category: 'adjust',
        params: [
          { id: 'hue', label: 'Matiz', min: -1, max: 1, default: 0, step: 0.01 },
          { id: 'saturation', label: 'Saturacion', min: -1, max: 1, default: 0, step: 0.01 }
        ]
      },
      'vibrance': {
        name: 'Vibrance',
        category: 'adjust',
        params: [
          { id: 'amount', label: 'Cantidad', min: -1, max: 1, default: 0.5, step: 0.01 }
        ]
      },
      'denoise': {
        name: 'Denoise',
        category: 'adjust',
        params: [
          { id: 'exponent', label: 'Exponente', min: 0, max: 50, default: 20, step: 1 }
        ]
      },
      'unsharpMask': {
        name: 'Unsharp Mask',
        category: 'adjust',
        params: [
          { id: 'radius', label: 'Radio', min: 0, max: 200, default: 20, step: 1 },
          { id: 'strength', label: 'Fuerza', min: 0, max: 5, default: 2, step: 0.1 }
        ]
      },
      'noise': {
        name: 'Noise',
        category: 'adjust',
        params: [
          { id: 'amount', label: 'Cantidad', min: 0, max: 1, default: 0.5, step: 0.01 }
        ]
      },
      'sepia': {
        name: 'Sepia',
        category: 'adjust',
        params: [
          { id: 'amount', label: 'Cantidad', min: 0, max: 1, default: 1, step: 0.01 }
        ]
      },
      'vignette': {
        name: 'Vignette',
        category: 'adjust',
        params: [
          { id: 'size', label: 'Tamano', min: 0, max: 1, default: 0.5, step: 0.01 },
          { id: 'amount', label: 'Cantidad', min: 0, max: 1, default: 0.5, step: 0.01 }
        ]
      },
      'zoomBlur': {
        name: 'Zoom Blur',
        category: 'blur',
        params: [
          { id: 'centerX', label: 'Centro X', min: 0, max: 1, default: 0.5, step: 0.01 },
          { id: 'centerY', label: 'Centro Y', min: 0, max: 1, default: 0.5, step: 0.01 },
          { id: 'strength', label: 'Fuerza', min: 0, max: 1, default: 0.3, step: 0.01 }
        ]
      },
      'triangleBlur': {
        name: 'Triangle Blur',
        category: 'blur',
        params: [
          { id: 'radius', label: 'Radio', min: 0, max: 200, default: 50, step: 1 }
        ]
      },
      'tiltShift': {
        name: 'Tilt Shift',
        category: 'blur',
        params: [
          { id: 'startX', label: 'Inicio X', min: 0,
          max: 1, default: 0.15, step: 0.01 },
          { id: 'startY', label: 'Inicio Y', min: 0, max: 1, default: 0.75, step: 0.01 },
          { id: 'endX', label: 'Fin X', min: 0, max: 1, default: 0.85, step: 0.01 },
          { id: 'endY', label: 'Fin Y', min: 0, max: 1, default: 0.25, step: 0.01 },
          { id: 'blurRadius', label: 'Radio Blur', min: 0, max: 50, default: 15, step: 1 },
          { id: 'gradientRadius', label: 'Radio Gradiente', min: 0, max: 400, default: 200, step: 1 }
        ]
      },
      'lensBlur': {
        name: 'Lens Blur',
        category: 'blur',
        params: [
          { id: 'radius', label: 'Radio', min: 0, max: 50, default: 10, step: 1 },
          { id: 'brightness', label: 'Brillo', min: -1, max: 1, default: 0.75, step: 0.01 },
          { id: 'angle', label: 'Angulo', min: 0, max: 6.28, default: 0, step: 0.01 }
        ]
      },
      'swirl': {
        name: 'Swirl',
        category: 'warp',
        params: [
          { id: 'centerX', label: 'Centro X', min: 0, max: 1, default: 0.5, step: 0.01 },
          { id: 'centerY', label: 'Centro Y', min: 0, max: 1, default: 0.5, step: 0.01 },
          { id: 'radius', label: 'Radio', min: 0, max: 600, default: 200, step: 1 },
          { id: 'angle', label: 'Angulo', min: -25, max: 25, default: 3, step: 0.1 }
        ]
      },
      'bulgePinch': {
        name: 'Bulge / Pinch',
        category: 'warp',
        params: [
          { id: 'centerX', label: 'Centro X', min: 0, max: 1, default: 0.5, step: 0.01 },
          { id: 'centerY', label: 'Centro Y', min: 0, max: 1, default: 0.5, step: 0.01 },
          { id: 'radius', label: 'Radio', min: 0, max: 600, default: 200, step: 1 },
          { id: 'strength', label: 'Fuerza', min: -1, max: 1, default: 0.5, step: 0.01 }
        ]
      },
      'ink': {
        name: 'Ink',
        category: 'fun',
        params: [
          { id: 'strength', label: 'Fuerza', min: 0, max: 1, default: 0.25, step: 0.01 }
        ]
      },
      'edgeWork': {
        name: 'Edge Work',
        category: 'fun',
        params: [
          { id: 'radius', label: 'Radio', min: 0, max: 200, default: 2, step: 1 }
        ]
      },
      'hexagonalPixelate': {
        name: 'Hexagonal Pixelate',
        category: 'fun',
        params: [
          { id: 'centerX', label: 'Centro X', min: 0, max: 1, default: 0.5, step: 0.01 },
          { id: 'centerY', label: 'Centro Y', min: 0, max: 1, default: 0.5, step: 0.01 },
          { id: 'scale', label: 'Escala', min: 1, max: 100, default: 10, step: 1 }
        ]
      },
      'dotScreen': {
        name: 'Dot Screen',
        category: 'fun',
        params: [
          { id: 'centerX', label: 'Centro X', min: 0, max: 1, default: 0.5, step: 0.01 },
          { id: 'centerY', label: 'Centro Y', min: 0, max: 1, default: 0.5, step: 0.01 },
          { id: 'angle', label: 'Angulo', min: 0, max: 6.28, default: 1.1, step: 0.01 },
          { id: 'size', label: 'Tamano', min: 1, max: 50, default: 3, step: 0.1 }
        ]
      },
      'colorHalftone': {
        name: 'Color Halftone',
        category: 'fun',
        params: [
          { id: 'centerX', label: 'Centro X', min: 0, max: 1, default: 0.5, step: 0.01 },
          { id: 'centerY', label: 'Centro Y', min: 0, max: 1, default: 0.5, step: 0.01 },
          { id: 'angle', label: 'Angulo', min: 0, max: 6.28, default: 1.1, step: 0.01 },
          { id: 'size', label: 'Tamano', min: 1, max: 50, default: 4, step: 0.1 }
        ]
      }
    };
  }

  createUI(parentElement) {
    const section = document.createElement('div');
    section.id = this.idSection;
    section.className = 'giodefaultimgeditor-filter-section';
    const selectHTML = this._generateSelectHTML();
    section.innerHTML = `
      <button class="giodefaultimgeditor-filter-toggle-btn" id="${this.idToggleBtn}">
        GLFX
      </button>
      <div class="giodefaultimgeditor-filter-controls" id="${this.prefix}_glfx_controls">
        <div class="giodefaultimgeditor-filter-select-wrapper">
          <label class="giodefaultimgeditor-filter-select-label">Select Filter:</label>
          <select id="${this.idFilterSelect}" class="giodefaultimgeditor-filter-select">
            <option value="">-- None --</option>
            ${selectHTML}
          </select>
        </div>
        <div id="${this.prefix}_glfx_dynamic_controls"></div>
      </div>
    `;
    parentElement.appendChild(section);
    this.controlsContainer = document.getElementById(`${this.prefix}_glfx_controls`);
    this.currentFilterControls = document.getElementById(`${this.prefix}_glfx_dynamic_controls`);
    document.getElementById(this.idToggleBtn).addEventListener('click', () => this.toggle());
    document.getElementById(this.idFilterSelect).addEventListener('change', e => {
      this._onFilterChange(e.target.value);
    });
  }

  _generateSelectHTML() {
    const categories = {
      adjust: '---- Adjust -----',
      blur: '---- Blur -----',
      warp: '---- Warp -----',
      fun: '---- Fun -----'
    };
    let html = '';
    for (const [catKey, catLabel] of Object.entries(categories)) {
      html += `<option disabled="true">${catLabel}</option>`;
      for (const [filterKey, filterDef] of Object.entries(this.filterDefinitions)) {
        if (filterDef.category === catKey) {
          html += `<option value="${filterKey}">${filterDef.name}</option>`;
        }
      }
    }
    return html;
  }

  _onFilterChange(filterKey) {
    if (this.currentFilterControls) {
      this.currentFilterControls.innerHTML = '';
    }
    for (const key in this.controls) {
      this.controls[key]?.destroy();
    }
    this.controls = {};
    if (!filterKey) {
      this.currentFilter = null;
      this.onUpdate?.();
      return;
    }
    this.currentFilter = filterKey;
    const filterDef = this.filterDefinitions[filterKey];
    if (!filterDef) return;
    const onChange = () => this.isActive && this.onUpdate?.();
    filterDef.params.forEach(param => {
      const sliderId = `${this.prefix}_glfx_${filterKey}_${param.id}`;
      this.controls[param.id] = new GioUISliderBasico(
        this.currentFilterControls,
        param.min,
        param.max,
        { onChange },
        sliderId,
        param.label,
        param.default,
        param.step
      );
    });
    this.onUpdate?.();
  }

  toggle() {
    this.isActive = !this.isActive;
    if (this.controlsContainer) {
      this.controlsContainer.style.display = this.isActive ? 'block' : 'none';
    }
    const btn = document.getElementById(this.idToggleBtn);
    btn?.classList.toggle('giodefaultimgeditor-active', this.isActive);
    this.onUpdate?.();
  }

  initGLFX(width, height) {
    try {
      this.glfxTexture?.destroy();
      this.glfxTexture = null;
      this.glfxCanvas = fx.canvas();
      this.glfxCanvas.width = width;
      this.glfxCanvas.height = height;
    } catch (e) {
      console.error('Error initializing GLFX:', e);
      this.glfxCanvas = null;
    }
  }

  applyFilter(sourceCanvas) {
    if (!this.isActive || !this.currentFilter || !this.glfxCanvas) {
      return sourceCanvas;
    }

    try {
      if (this.glfxCanvas.width !== sourceCanvas.width || this.glfxCanvas.height !== sourceCanvas.height) {
        this.initGLFX(sourceCanvas.width, sourceCanvas.height);
      }

      this.glfxTexture?.destroy();
      this.glfxTexture = this.glfxCanvas.texture(sourceCanvas);

      this.glfxCanvas.draw(this.glfxTexture);

      const filterDef = this.filterDefinitions[this.currentFilter];
      if (!filterDef) return sourceCanvas;

      const params = filterDef.params.map(param => {
        const value = this.controls[param.id]?.getValue() ?? param.default;
        if (['centerX', 'startX', 'endX'].includes(param.id)) {
          return value * this.glfxCanvas.width;
        } else if (['centerY', 'startY', 'endY'].includes(param.id)) {
          return value * this.glfxCanvas.height;
        } else {
          return value;
        }
      });

      this.glfxCanvas[this.currentFilter](...params);
      this.glfxCanvas.update();

      return this.glfxCanvas;
    } catch (e) {
      console.error('Error applying GLFX filter:', e);
      return sourceCanvas;
    }
  }
}

class FilterManager {
  constructor(idPrefix) {
    this.prefix = idPrefix;
    this.idCanvas = `${this.prefix}_canvas`;
    this.idFiltersContainer = `${this.prefix}_filters_container`;
    this.canvas = null;
    this.ctx = null;
    this.originalImage = null;
    this.imageLoader = null;
    this.carbonFilter = null;
    this.glfxManager = null;
    this.escalaDeGrisFilter = null;
    this.tempCanvas = null;
    this.tempCtx = null;
  }

  init() {
    this.canvas = document.getElementById(this.idCanvas);
    this.ctx = this.canvas.getContext('2d', { willReadFrequently: true });

    this.tempCanvas = document.createElement('canvas');
    this.tempCtx = this.tempCanvas.getContext('2d', { willReadFrequently: true });

    this.imageLoader = new ImageLoader({
      onImageLoad: img => this._onImageLoaded(img)
    }, this.prefix);

    this.imageLoader.init();

    const filtersContainer = document.getElementById(this.idFiltersContainer);

    this.carbonFilter = new CarbonDrawingFilter(this.canvas, () => this._updateCanvas(), this.prefix);
    this.carbonFilter.createUI(filtersContainer);

    this.glfxManager = new GLFXFilterManager(() => this._updateCanvas(), this.prefix);
    this.glfxManager.createUI(filtersContainer);

    this.escalaDeGrisFilter = new EscalaDeGrisFilter(this.canvas, () => this._updateCanvas(), this.prefix);
    this.escalaDeGrisFilter.createUI(filtersContainer);
  }

  async setImage(imageSource) {
    let img = new Image();
    if (typeof imageSource === 'string') {
      img.crossOrigin = 'anonymous';
      img.src = imageSource;
      await img.decode();
    } else if (imageSource instanceof File) {
      const reader = new FileReader();
      reader.readAsDataURL(imageSource);
      await new Promise(resolve => reader.onload = () => {
        img.src = reader.result;
        resolve();
      });
      await img.decode();
    } else if (imageSource instanceof HTMLImageElement) {
      img = imageSource;
    } else if (imageSource instanceof ImageData) {
      this.tempCanvas.width = imageSource.width;
      this.tempCanvas.height = imageSource.height;
      this.tempCtx.putImageData(imageSource, 0, 0);
      img.src = this.tempCanvas.toDataURL();
      await img.decode();
    } else if (imageSource instanceof HTMLCanvasElement) {
      img.src = imageSource.toDataURL();
      await img.decode();
    } else {
      console.error("Unsupported image source type.");
      return;
    }
    this._onImageLoaded(img);
  }

  _onImageLoaded(img) {
    this.originalImage = img;
    this._resizeCanvas(img);
    this._updateCanvas();
  }

  _resizeCanvas(img) {
    const maxWidth = window.innerWidth > 768 ? 1200 : window.innerWidth - 40;
    const maxHeight = window.innerHeight - 120;
    let width = img.width;
    let height = img.height;
    const aspectRatio = width / height;

    if (width > maxWidth) {
      width = maxWidth;
      height = width / aspectRatio;
    }
    if (height > maxHeight) {
      height = maxHeight;
      width = height * aspectRatio;
    }

    this.canvas.width = width;
    this.canvas.height = height;
    this.tempCanvas.width = width;
    this.tempCanvas.height = height;

    if (this.glfxManager.isActive) {
      this.glfxManager.initGLFX(width, height);
    }
  }

  _updateCanvas() {
    if (!this.originalImage) return;

    try {
      this.ctx.fillStyle = '#ffffff';
      this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
      this.ctx.drawImage(this.originalImage, 0, 0, this.canvas.width, this.canvas.height);

      if (this.escalaDeGrisFilter.isActive) {
        let imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
        imageData = this.escalaDeGrisFilter.applyFilter(imageData);
        this.ctx.putImageData(imageData, 0, 0);
      }

      if (this.carbonFilter.isActive) {
        let imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
        imageData = this.carbonFilter.applyFilter(imageData);
        this.ctx.putImageData(imageData, 0, 0);
      }

      if (this.glfxManager.isActive && this.glfxManager.currentFilter) {
        if (!this.glfxManager.glfxCanvas) {
          this.glfxManager.initGLFX(this.canvas.width, this.canvas.height);
        }

        const resultCanvas = this.glfxManager.applyFilter(this.canvas);

        if (resultCanvas && resultCanvas !== this.canvas) {
          this.ctx.drawImage(resultCanvas, 0, 0);
        }
      }
    } catch (error) {
      console.error('Error updating canvas:', error);
    }
  }
}

class AppEditorDefaultImg {
  constructor(parentElement, idGenerico, textEdi = "Gio", event = {}) {
    this.idGenerico = idGenerico;
    this.parentElement = parentElement;
    this.textoedi = textEdi;

    const appHTML = `
      <div class="giodefaultimgeditor-app-container">
        <button class="giodefaultimgeditor-hamburger-btn" id="${this.idGenerico}_hamburger_btn">
          <span></span>
          <span></span>
          <span></span>
        </button>
        
        <div class="giodefaultimgeditor-sidebar" id="${this.idGenerico}_sidebar">
          <div class="giodefaultimgeditor-sidebar-header">
            <div class="giodefaultimgeditor-sidebar-titl giodefaultimgeditor-classlesfttext" id="${this.idGenerico}textoedi">${this.textoedi}</div>
            <div class="giodefaultimgeditor-sidebar-subtitle giodefaultimgeditor-classlesfttextR">Load and apply professional effects</div>
          </div>

          <div class="giodefaultimgeditor-upload-section">
            <button class="giodefaultimgeditor-upload-btn giodefaultimgeditor-upload-btn-primary" id="${this.idGenerico}_upload_btn">
              Upload Image
            </button>
            <button class="giodefaultimgeditor-upload-btn giodefaultimgeditor-upload-btn-secondary" id="${this.idGenerico}_paste_btn">
              Paste
            </button>
            <button class="giodefaultimgeditor-upload-btn giodefaultimgeditor-upload-btn-secondary" id="${this.idGenerico}closeImageEditor">
              Close
            </button>
            <input type="file" class="giodefaultimgeditor-file-input" id="${this.idGenerico}_file_input" accept="image/*">
            <div class="giodefaultimgeditor-upload-info">Drag an image or use Ctrl+V</div>
          </div>

          <div class="giodefaultimgeditor-filters-title">Available Filters</div>
          <div id="${this.idGenerico}_filters_container"></div>
        </div>

        <div class="giodefaultimgeditor-main-content" id="${this.idGenerico}_main_content">
          <div class="giodefaultimgeditor-canvas-wrapper">
            <canvas class="giodefaultimgeditor-canvas" id="${this.idGenerico}_canvas" width="800" height="600"></canvas>
          </div>
        </div>

        <div class="giodefaultimgeditor-drop-zone" id="${this.idGenerico}_drop_zone">
          <div class="giodefaultimgeditor-drop-message">Drop the image here</div>
        </div>
      </div>
    `;

    this.parentElement.innerHTML = appHTML;

    this.sidebar = document.getElementById(`${this.idGenerico}_sidebar`);
    this.hamburgerBtn = document.getElementById(`${this.idGenerico}_hamburger_btn`);
    this.mainContent = document.getElementById(`${this.idGenerico}_main_content`);

    this.hamburgerBtn.addEventListener('click', () => this.toggleSidebar());

    this.filterManager = new FilterManager(this.idGenerico);
    this.filterManager.init();
    this.LabelEdit = document.getElementById(`${this.idGenerico}textoedi`);
    this.botonCloseEditor = document.getElementById(`${this.idGenerico}closeImageEditor`);
    this.botonCloseEditor.onclick = (e) => {
      var soporteApp = this.parentElement;
      soporteApp.style.display = soporteApp.style.display === 'none' ? 'block' : 'none';
    }
    this._initResponsive();
  }

  _initResponsive() {
    this._handleResize();
    window.addEventListener('resize', () => this._handleResize());
  }

  _handleResize() {
    if (window.innerWidth <= 768) {
      this.sidebar.classList.add('hidden');
      this.hamburgerBtn.classList.remove('active');
      this.mainContent.classList.add('sidebar-hidden');
    } else {
      this.sidebar.classList.remove('hidden');
      this.hamburgerBtn.classList.remove('active');
      this.mainContent.classList.remove('sidebar-hidden');
    }
  }

  toggleSidebar() {
    this.sidebar.classList.toggle('hidden');
    this.hamburgerBtn.classList.toggle('active');
    this.mainContent.classList.toggle('sidebar-hidden');
  }

  async setImage(imageSource) {
    await this.filterManager.setImage(imageSource);
  }
}

window.appEditorgioBasico = null;
document.addEventListener('DOMContentLoaded', () => {
  const parenthtml1 = document.getElementById("idSoporteApp");
  window.appEditorgioBasico = new AppEditorDefaultImg(parenthtml1, 'app1', "Edit");
});



  </script>




<!-- end filtros demasordenados -->








































<!-- end filtros demasordenados -->








    <script src="https://unonibes4a.github.io/pintaresta/gioUI.js"></script>
 

    <script>
class EditorImgz {
    constructor(id = null) {
        this.container = null;
        this.container = document.getElementById(id);
        this.editor = null;
        this.upscaler = null;
        this.backgroundRemoval = null;
        this.editorid = 'editorimgz-main';

        this.inyectarEstilosCSS('mis-estilos-glfx');
        this.init();
    }

    changeImgUrl(imgurl) {
        document.getElementById("editorimgz-image").src = imgurl;
    }

    inyectarEstilosCSS = (idDeLaHoja) => {
        let hojaDeEstilos = document.getElementById(idDeLaHoja);
        if (!hojaDeEstilos) {
            hojaDeEstilos = document.createElement('style');
            hojaDeEstilos.id = idDeLaHoja;
            hojaDeEstilos.type = 'text/css';
            document.head.appendChild(hojaDeEstilos);
        }
        var reglasCSS = `
            .glfx-canvas {
                max-width: 100%;
                max-height: 80vh;
                width: auto !important;
                height: auto !important;
                object-fit: contain;
                background-color: #eee;
                display: block;
                margin: 0 auto;
            }
            #contenedor-principal {
                padding: 20px;
                background-color: #f0f0f0;
                border: 1px solid #ccc;
            }
        `;
        hojaDeEstilos.innerHTML = reglasCSS;
    }

    init() {
        this.injectStyles();
        this.createDOMStructure();
        this.loadResources().then(() => {
            this.setupEventHandlers();
            this.initializeCore();
        });
    }

    injectStyles() {
        const style = document.createElement('style');
        style.textContent = `.editorimgz-container{font-family:sans-serif;background:#f0f0f0;color:#333;margin:0;padding:20px}.editorimgz-title{text-align:center;color:#111;margin-bottom:20px}.editorimgz-main{overflow-y:auto;max-width:1400px;margin:0 auto;display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;background:white;padding:20px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.1);border:2px dashed transparent;transition:border-color 0.3s}@media(max-width:768px){.editorimgz-main{flex-direction:column;padding:10px}}.editorimgz-main.drag-over{border-color:#007bff}.editorimgz-canvas-wrapper{flex-grow:1;min-width:300px;position:relative;display:flex;justify-content:center;align-items:center}.editorimgz-loader{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);z-index:10;display:none;justify-content:center;align-items:center;font-size:1.5em;color:#333;font-weight:bold;border-radius:4px}.editorimgz-canvas{max-width:100%;max-height:80vh;width:auto !important;height:auto !important;object-fit:contain;border:1px solid #ddd;border-radius:4px;display:block}@media(max-width:768px){.editorimgz-canvas{max-height:50vh}}.editorimgz-controls{display:flex;flex-direction:column;gap:15px;min-width:320px;flex-basis:320px}@media(max-width:768px){.editorimgz-controls{min-width:100%;flex-basis:100%}}.editorimgz-section{background:#f9f9f9;padding:15px;border-radius:4px;border:1px solid #eee}.editorimgz-section h3{margin-top:0;text-align:center;border-bottom:1px solid #ddd;padding-bottom:10px;margin-bottom:15px}.editorimgz-section p{font-size:0.9em;text-align:center;color:#555;margin-top:0}.editorimgz-btn{display:block;width:100%;box-sizing:border-box;background-color:#007bff;color:white;padding:10px 15px;border-radius:4px;text-align:center;cursor:pointer;transition:background-color 0.2s;border:none;font-size:1em;margin-bottom:10px}.editorimgz-btn:hover{background-color:#0056b3}.editorimgz-btn-secondary{background-color:#6c757d}.editorimgz-btn-secondary:hover{background-color:#5a6268}.editorimgz-btn-success{background-color:#28a745}.editorimgz-btn-success:hover{background-color:#218838}.editorimgz-btn-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}.editorimgz-file-input{display:none}.editorimgz-filters{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;background:#fff}.editorimgz-filter-controls{margin-top:10px}.editorimgz-filter{margin-bottom:10px;border-left:3px solid #007bff;padding-left:10px}.editorimgz-filter label{display:block;margin-bottom:5px;font-weight:bold;font-size:0.9em}.editorimgz-filter input[type="range"]{width:100%}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9998;display:none}.modal-overlay.active{display:block}`;
        document.head.appendChild(style);
    }

    crearuicongioUI = () => {
        var mainContainerUIGio = document.createElement('div');
        let parent = document.getElementById(this.editorid);
        parent.appendChild(mainContainerUIGio);
        mainContainerUIGio.className = 'clgiobasica';

        var botonscalar2x = new GioUI.Button(mainContainerUIGio, { text: 'SC', variant: 'default' }, () => {
            if (confirm("scale img AI")) {
                let sx = parseInt(prompt("up scale 2 or 4", 2));
                if (sx > 4) { sx = 4; alert("change value to 4 "); }
                if (sx < 2) { sx = 2; alert("change value to 2 "); }
                if (sx == 3) { sx = 4; alert("change value to 4"); }
                this.processUpscale(sx)
            }
        });
        var butodremovebg = new GioUI.Button(mainContainerUIGio, { text: 'BG', variant: 'default' }, () => { this.removeBackground() });
    }

    createDOMStructure() {
        this.container.className = 'editorimgz-container';

        const title = document.createElement('h1');
        title.className = 'editorimgz-title';
        title.textContent = 'Editor de Imgenes Pro';
        this.container.appendChild(title);

        // Crear overlay para cerrar modal
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.id = 'editorimgz-overlay';
        document.body.appendChild(overlay);

        const mainContainer = document.createElement('div');
        mainContainer.className = this.editorid;
        mainContainer.id = this.editorid;
        this.container.appendChild(mainContainer);

        const canvasWrapper = document.createElement('div');
        canvasWrapper.className = 'editorimgz-canvas-wrapper';
        mainContainer.appendChild(canvasWrapper);

        const loader = document.createElement('div');
        loader.className = 'editorimgz-loader';
        loader.id = 'editorimgz-loader';
        loader.textContent = 'Procesando...';
        canvasWrapper.appendChild(loader);

        const canvas = document.createElement('canvas');
        canvas.className = 'editorimgz-canvas';
        canvas.id = 'editorimgz-canvas';
        canvas.width = 800;
        canvas.height = 600;
        canvasWrapper.appendChild(canvas);

        const controlsContainer = document.createElement('div');
        controlsContainer.className = 'editorimgz-controls';
        controlsContainer.id = 'editorimgz-controls';
        mainContainer.appendChild(controlsContainer);

        const hiddenImage = document.createElement('img');
        hiddenImage.crossOrigin = "Anonymous";
        hiddenImage.id = 'editorimgz-image';
        hiddenImage.src = 'https://media-cdn.tripadvisor.com/media/attractions-splice-spp-674x446/07/9e/00/b2.jpg';
        hiddenImage.style.display = 'none';
        hiddenImage.crossOrigin = 'anonymous';
        controlsContainer.appendChild(hiddenImage);

        this.createControlSection(controlsContainer, 'Cargar Imagen', 'Sube, arrastra o pega una imagen.', [
            { type: 'file', id: 'editorimgz-file-input', label: 'Seleccionar Archivo' }
        ]);

        this.createControlSection(controlsContainer, 'Operaciones Avanzadas', '', [
            {
                type: 'button-grid', buttons: [
                    { id: 'editorimgz-upscale-2x', text: 'Upscale 2x' },
                    { id: 'editorimgz-upscale-4x', text: 'Upscale 4x' }
                ]
            },
            { type: 'button', id: 'editorimgz-remove-bg', text: 'Eliminar Fondo' },
            { type: 'button', id: 'editorimgz-download', text: 'Descargar Imagen', success: true }
        ]);

        this.createControlSection(controlsContainer, 'Transformaciones', '', [
            { type: 'button', id: 'editorimgz-invert', text: 'Invertir Colores', secondary: true },
            { type: 'button', id: 'editorimgz-drawing-effect', text: 'Dibujo a Lpiz', secondary: true },
            {
                type: 'button-grid', buttons: [
                    { id: 'editorimgz-flip-x', text: 'Voltear H', secondary: true },
                    { id: 'editorimgz-flip-y', text: 'Voltear V', secondary: true }
                ]
            },
            { type: 'button', id: 'editorimgz-quad', text: 'Cuadruplicar Espejo', secondary: true }
        ]);

        this.createFilterSection(controlsContainer);

        this.crearuicongioUI();
    }

    createControlSection(container, title, description, elements) {
        const section = document.createElement('div');
        section.className = 'editorimgz-section';

        const titleElement = document.createElement('h3');
        titleElement.textContent = title;
        section.appendChild(titleElement);

        if (description) {
            const descElement = document.createElement('p');
            descElement.textContent = description;
            section.appendChild(descElement);
        }

        elements.forEach(element => {
            if (element.type === 'button') {
                const button = document.createElement('button');
                button.id = element.id;
                let className = 'editorimgz-btn';
                if (element.secondary) className += ' editorimgz-btn-secondary';
                if (element.success) className += ' editorimgz-btn-success';
                button.className = className;
                button.textContent = element.text;
                section.appendChild(button);
            }
            else if (element.type === 'button-grid') {
                const grid = document.createElement('div');
                grid.className = 'editorimgz-btn-grid';
                element.buttons.forEach(btn => {
                    const button = document.createElement('button');
                    button.id = btn.id;
                    button.className = btn.secondary ? 'editorimgz-btn editorimgz-btn-secondary' : 'editorimgz-btn';
                    button.textContent = btn.text;
                    grid.appendChild(button);
                });
                section.appendChild(grid);
            }
            else if (element.type === 'file') {
                const label = document.createElement('label');
                label.htmlFor = element.id;
                label.className = 'editorimgz-btn file-input-label';
                label.textContent = element.label;
                section.appendChild(label);

                const input = document.createElement('input');
                input.type = 'file';
                input.id = element.id;
                input.className = 'editorimgz-file-input';
                input.accept = 'image/*';
                section.appendChild(input);
            }
        });

        container.appendChild(section);
    }

    createFilterSection(container) {
        const section = document.createElement('div');
        section.className = 'editorimgz-section';

        const title = document.createElement('h3');
        title.textContent = 'Filtros GLFX';
        section.appendChild(title);

        const select = document.createElement('select');
        select.id = 'editorimgz-filters';
        select.className = 'editorimgz-filters';
        section.appendChild(select);

        const filterOptions = [
            { value: '', text: '---- Elige un Filtro -----', disabled: true },
            { value: 'original', text: 'Imagen Original' },
            { value: '', text: '---- Ajustes -----', disabled: true },
            { value: 'Brightness / Contrast', text: 'Brightness / Contrast' },
            { value: 'Hue / Saturation', text: 'Hue / Saturation' },
            { value: 'Vibrance', text: 'Vibrance' },
            { value: 'Denoise', text: 'Denoise' },
            { value: 'Unsharp Mask', text: 'Unsharp Mask' },
            { value: 'Noise', text: 'Noise' },
            { value: 'Sepia', text: 'Sepia' },
            { value: 'Vignette', text: 'Vignette' },
            { value: '', text: '---- Desenfoques -----', disabled: true },
            { value: 'Zoom Blur', text: 'Zoom Blur' },
            { value: 'Triangle Blur', text: 'Triangle Blur' },
            { value: 'Tilt Shift', text: 'Tilt Shift' },
            { value: 'Lens Blur', text: 'Lens Blur' },
            { value: '', text: '---- Deformaciones -----', disabled: true },
            { value: 'Swirl', text: 'Swirl' },
            { value: 'Bulge / Pinch', text: 'Bulge / Pinch' },
            { value: 'Perspective', text: 'Perspective' },
            { value: '', text: '---- Diversin -----', disabled: true },
            { value: 'Ink', text: 'Ink' },
            { value: 'Edge Work', text: 'Edge Work' },
            { value: 'Hexagonal Pixelate', text: 'Hexagonal Pixelate' },
            { value: 'Dot Screen', text: 'Dot Screen' },
            { value: 'Color Halftone', text: 'Color Halftone' }
        ];

        filterOptions.forEach(option => {
            const optElement = document.createElement('option');
            optElement.value = option.value;
            optElement.textContent = option.text;
            if (option.disabled) {
                optElement.disabled = true;
                if (!option.value) optElement.selected = true;
            }
            select.appendChild(optElement);
        });

        const filterControls = document.createElement('div');
        filterControls.id = 'editorimgz-filter-controls';
        filterControls.className = 'editorimgz-filter-controls';
        section.appendChild(filterControls);

        container.appendChild(section);
    }

    async loadResources() {
        await this.loadScript('https://evanw.github.io/glfx.js/glfx.js');
        const { removeBackground } = await import('https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.6.0/+esm');
        const Upscaler = await import('https://cdn.jsdelivr.net/npm/upscaler@1.0.0-beta.19/+esm');

        this.backgroundRemoval = removeBackground;
        this.upscaler = new Upscaler.default();
    }

    loadScript(src) {
        return new Promise((resolve, reject) => {
            if (document.querySelector(`script[src="${src}"]`)) {
                resolve();
                return;
            }

            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    setupEventHandlers() {
        const mainContainer = document.getElementById('editorimgz-main');
        const fileInput = document.getElementById('editorimgz-file-input');
        const imageElement = document.getElementById('editorimgz-image');
        const overlay = document.getElementById('editorimgz-overlay');

        // Cerrar modal al hacer click fuera
        overlay.addEventListener('click', () => {
            this.container.style.display = 'none';
            overlay.classList.remove('active');
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files?.[0]) {
                this.loadImageFromFile(e.target.files[0]);
            }
        });

        document.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    e.preventDefault();
                    this.loadImageFromFile(item.getAsFile());
                    break;
                }
            }
        });

        mainContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            mainContainer.classList.add('drag-over');
        });

        mainContainer.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            mainContainer.classList.remove('drag-over');
        });

        mainContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            mainContainer.classList.remove('drag-over');
            if (e.dataTransfer.files?.[0]) {
                this.loadImageFromFile(e.dataTransfer.files[0]);
            }
        });

        document.getElementById('editorimgz-upscale-2x').addEventListener('click', () => this.processUpscale(2));
        document.getElementById('editorimgz-upscale-4x').addEventListener('click', () => this.processUpscale(4));
        document.getElementById('editorimgz-remove-bg').addEventListener('click', () => this.removeBackground());
        document.getElementById('editorimgz-download').addEventListener('click', () => this.downloadImage());
        document.getElementById('editorimgz-invert').addEventListener('click', () => this.editor?.invertColors());
        document.getElementById('editorimgz-drawing-effect').addEventListener('click', () => this.applyDrawingEffect());
        document.getElementById('editorimgz-flip-x').addEventListener('click', () => this.editor?.flip('x'));
        document.getElementById('editorimgz-flip-y').addEventListener('click', () => this.editor?.flip('y'));
        document.getElementById('editorimgz-quad').addEventListener('click', () => this.quadrupleImage());

        imageElement.onload = () => this.initializeEditor();
    }

    initializeCore() {
        const image = document.getElementById('editorimgz-image');
        if (image.complete && image.naturalHeight !== 0) {
            this.initializeEditor();
        }
    }

    initializeEditor() {
        var image = document.getElementById('editorimgz-image');
        const canvas = document.getElementById('editorimgz-canvas');

        if (!this.editor) {
            if (document.getElementById("editorimgz-canvasglfx")) {
                const glfxCanvas = document.getElementById("editorimgz-canvasglfx");
                glfxCanvas.style.maxWidth = "100%";
                glfxCanvas.style.maxHeight = "80vh";
                glfxCanvas.style.width = "auto";
                glfxCanvas.style.height = "auto";
                glfxCanvas.style.objectFit = "contain";
            }

            try {
                this.editor = new this.GLFXEditor(
                    'editorimgz-canvas',
                    'editorimgz-filter-controls',
                    'editorimgz-image',
                    'editorimgz-filters'
                );
                this.editor.applyFilters();
            } catch (e) {
                console.error('Error initializing editor:', e);
                alert('Tu navegador no soporta WebGL.');
            }
        }
        else {
            this.editor.updateImage(image);
        }
    }

    downloadImage() {
        try {
            const canvas = document.getElementById('editorimgz-canvasglfx');
            if (!canvas) {
                alert('No hay imagen para descargar');
                return;
            }

            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const timestamp = new Date().getTime();
                link.download = `imagen-editada-${timestamp}.png`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            });
        } catch (error) {
            console.error('Error al descargar:', error);
            alert('Error al descargar la imagen');
        }
    }

    applyDrawingEffect() {
        this.showLoader('Aplicando efecto dibujo...');
        
        setTimeout(() => {
            try {
                const img = document.getElementById('editorimgz-image');
                const tempCanvas = document.createElement('canvas');
                const ctx = tempCanvas.getContext('2d');
                
                tempCanvas.width = img.naturalWidth;
                tempCanvas.height = img.naturalHeight;
                
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                ctx.filter = 'grayscale(100%) contrast(150%) brightness(110%)';
                ctx.globalAlpha = 0.85;
                ctx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
                ctx.filter = 'none';
                ctx.globalAlpha = 1.0;
                
                this.applyPencilTexture(ctx, tempCanvas.width, tempCanvas.height);
                this.applyDrawingGrid(ctx, tempCanvas.width, tempCanvas.height);
                
                img.src = tempCanvas.toDataURL();
            } catch (error) {
                console.error('Error aplicando efecto dibujo:', error);
                alert('Error al aplicar el efecto');
            } finally {
                this.hideLoader();
            }
        }, 100);
    }

    applyPencilTexture(ctx, width, height) {
        const imageData = ctx.getImageData(0, 0, width, height);
        const data = imageData.data;
        
        for (let i = 0; i < data.length; i += 4) {
            const noise = Math.random() * 15 - 7.5;
            data[i] = Math.min(255, Math.max(0, data[i] + noise));
            data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + noise));
            data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + noise));
        }
        
        ctx.putImageData(imageData, 0, 0);
    }

    applyDrawingGrid(ctx, width, height) {
        ctx.strokeStyle = 'rgba(200, 160, 140, 0.3)';
        ctx.lineWidth = 2;
        ctx.setLineDash([3, 3]);
        
        const cols = 14;
        const rows = 14;
        const cellWidth = width / cols;
        const cellHeight = height / rows;
        
        for (let i = 0; i <= cols; i++) {
            ctx.beginPath();
            ctx.moveTo(i * cellWidth, 0);
            ctx.lineTo(i * cellWidth, height);
            ctx.stroke();
        }
        
        for (let i = 0; i <= rows; i++) {
            ctx.beginPath();
            ctx.moveTo(0, i * cellHeight);
            ctx.lineTo(width, i * cellHeight);
            ctx.stroke();
        }
        
        ctx.setLineDash([]);
        
        ctx.fillStyle = 'rgba(200, 160, 140, 0.5)';
        const dotRadius = 2;
        for (let row = 0; row <= rows; row++) {
            for (let col = 0; col <= cols; col++) {
                ctx.beginPath();
                ctx.arc(col * cellWidth, row * cellHeight, dotRadius, 0, Math.PI * 2);
                ctx.fill();
            }
        }
    }

    GLFXEditor = class {
        constructor(canvasId, controlsId, imageId, filterSelectId) {
            this.canvas = fx.canvas();
            this.originalCanvas = document.getElementById(canvasId);
            this.controlsContainer = document.getElementById(controlsId);
            this.imageElement = document.getElementById(imageId);
            this.filterSelect = document.getElementById(filterSelectId);

            const existingCanvas = this.originalCanvas.parentNode.querySelector('.glfx-canvas');
            if (existingCanvas) {
                existingCanvas.remove();
            }

            this.originalCanvas.parentNode.insertBefore(this.canvas, this.originalCanvas);
            this.originalCanvas.style.display = 'none';
            this.canvas.id = this.originalCanvas.id + "glfx";
            
            // Mantener aspecto de la imagen
            const imgAspect = this.imageElement.naturalWidth / this.imageElement.naturalHeight;
            const maxWidth = 800;
            const maxHeight = 600;
            
            let canvasWidth, canvasHeight;
            if (imgAspect > 1) {
                canvasWidth = maxWidth;
                canvasHeight = maxWidth / imgAspect;
            } else {
                canvasHeight = maxHeight;
                canvasWidth = maxHeight * imgAspect;
            }
            
            this.canvas.width = canvasWidth;
            this.canvas.height = canvasHeight;
            this.canvas.style.maxWidth = "100%";
            this.canvas.style.maxHeight = "80vh";
            this.canvas.style.width = "auto";
            this.canvas.style.height = "auto";
            this.canvas.style.objectFit = "contain";

            this.texture = this.canvas.texture(this.imageElement);
            this.canvas.draw(this.texture).update();

            this.filters = {
                'Brightness / Contrast': [{ name: 'Brillo', prop: 'brightness', min: -1, max: 1, value: 0, step: 0.01 }, { name: 'Contraste', prop: 'contrast', min: -1, max: 1, value: 0, step: 0.01 }],
                'Hue / Saturation': [{ name: 'Tono', prop: 'hue', min: -1, max: 1, value: 0, step: 0.01 }, { name: 'Saturacin', prop: 'saturation', min: -1, max: 1, value: 0, step: 0.01 }],
                'Vibrance': [{ name: 'Cantidad', prop: 'amount', min: -1, max: 1, value: 0, step: 0.01 }],
                'Denoise': [{ name: 'Exponente', prop: 'exponent', min: 0, max: 50, value: 20, step: 1 }],
                'Unsharp Mask': [{ name: 'Radio', prop: 'radius', min: 0, max: 200, value: 20, step: 1 }, { name: 'Fuerza', prop: 'strength', min: 0, max: 5, value: 2, step: 0.01 }],
                'Noise': [{ name: 'Cantidad', prop: 'amount', min: 0, max: 1, value: 0.5, step: 0.01 }],
                'Sepia': [{ name: 'Cantidad', prop: 'amount', min: 0, max: 1, value: 0.5, step: 0.01 }],
                'Vignette': [{ name: 'Tamao', prop: 'size', min: 0, max: 1, value: 0.25, step: 0.01 }, { name: 'Cantidad', prop: 'amount', min: 0, max: 1, value: 0.5, step: 0.01 }],
                'Zoom Blur': [{ name: 'Fuerza', prop: 'strength', min: 0, max: 1, value: 0.3, step: 0.01 }],
                'Triangle Blur': [{ name: 'Radio', prop: 'radius', min: 0, max: 200, value: 25, step: 1 }],
                'Tilt Shift': [{ name: 'Radio Desenfoque', prop: 'blurRadius', min: 0, max: 50, value: 15, step: 1 }, { name: 'Radio Gradiente', prop: 'gradientRadius', min: 0, max: 400, value: 200, step: 1 }],
                'Lens Blur': [{ name: 'Radio', prop: 'radius', min: 0, max: 50, value: 4, step: 1 }, { name: 'Brillo', prop: 'brightness', min: -1, max: 1, value: 0, step: 0.01 }, { name: 'ngulo', prop: 'angle', min: -Math.PI, max: Math.PI, value: 0, step: 0.01 }],
                'Swirl': [{ name: 'Radio', prop: 'radius', min: 0, max: 600, value: 200, step: 1 }, { name: 'ngulo', prop: 'angle', min: -10, max: 10, value: 3, step: 0.1 }],
                'Bulge / Pinch': [{ name: 'Fuerza', prop: 'strength', min: -1, max: 1, value: 0.5, step: 0.01 }, { name: 'Radio', prop: 'radius', min: 0, max: 600, value: 200, step: 1 }],
                'Perspective': [{ name: 'x1', prop: 'x1', min: 0, max: 800, value: 175, step: 1 }, { name: 'y1', prop: 'y1', min: 0, max: 600, value: 20, step: 1 }, { name: 'x2', prop: 'x2', min: 0, max: 800, value: 625, step: 1 }, { name: 'y2', prop: 'y2', min: 0, max: 600, value: 50, step: 1 }, { name: 'x3', prop: 'x3', min: 0, max: 800, value: 175, step: 1 }, { name: 'y3', prop: 'y3', min: 0, max: 600, value: 580, step: 1 }, { name: 'x4', prop: 'x4', min: 0, max: 800, value: 625, step: 1 }, { name: 'y4', prop: 'y4', min: 0, max: 600, value: 550, step: 1 }],
                'Ink': [{ name: 'Fuerza', prop: 'strength', min: 0, max: 1, value: 0.25, step: 0.01 }],
                'Edge Work': [{ name: 'Radio', prop: 'radius', min: 0, max: 200, value: 1, step: 0.1 }],
                'Hexagonal Pixelate': [{ name: 'Escala', prop: 'scale', min: 1, max: 100, value: 20, step: 1 }],
                'Dot Screen': [{ name: 'Tamao', prop: 'size', min: 0, max: 20, value: 3, step: 0.1 }, { name: 'ngulo', prop: 'angle', min: 0, max: Math.PI / 2, value: 1.1, step: 0.01 }],
                'Color Halftone': [{ name: 'Tamao', prop: 'size', min: 1, max: 20, value: 4, step: 0.1 }, { name: 'ngulo', prop: 'angle', min: 0, max: Math.PI, value: 0.25, step: 0.01 }]
            };

            this.currentFilterValues = {};
            this.selectedFilter = this.filterSelect.value;

            this.handleFilterChange = this.handleFilterChange.bind(this);

            this.setupEvents();
            this.updateControls();
        }

        updateImage(newImageElement) {
            if (!newImageElement || !this.canvas) {
                return;
            }

            if (this.texture && typeof this.texture.destroy === 'function') {
                this.texture.destroy();
            }

            this.imageElement = newImageElement;

            const parentNode = this.canvas.parentNode;
            const nextSibling = this.canvas.nextSibling;

            this.canvas.remove();

            this.canvas = fx.canvas();
            
            // Mantener aspecto de la imagen
            const imgAspect = this.imageElement.naturalWidth / this.imageElement.naturalHeight;
            const maxWidth = 800;
            const maxHeight = 600;
            
            let canvasWidth, canvasHeight;
            if (imgAspect > 1) {
                canvasWidth = maxWidth;
                canvasHeight = maxWidth / imgAspect;
            } else {
                canvasHeight = maxHeight;
                canvasWidth = maxHeight * imgAspect;
            }
            
            this.canvas.width = canvasWidth;
            this.canvas.height = canvasHeight;
            this.canvas.id = this.originalCanvas.id + "glfx";
            this.canvas.className = 'glfx-canvas';
            this.canvas.style.maxWidth = "100%";
            this.canvas.style.maxHeight = "80vh";
            this.canvas.style.width = "auto";
            this.canvas.style.height = "auto";
            this.canvas.style.objectFit = "contain";

            if (nextSibling) {
                parentNode.insertBefore(this.canvas, nextSibling);
            } else {
                parentNode.appendChild(this.canvas);
            }

            this.texture = this.canvas.texture(this.imageElement);
            this.canvas.draw(this.texture).update();

            this.applyFilters();
        }

        destroy() {
            if (this.filterSelect) {
                this.filterSelect.removeEventListener('change', this.handleFilterChange);
            }

            if (this.texture && typeof this.texture.destroy === 'function') {
                this.texture.destroy();
            }

            if (this.canvas && this.canvas.parentNode) {
                this.canvas.remove();
            }

            if (this.controlsContainer) {
                this.controlsContainer.innerHTML = '';
            }

            if (this.originalCanvas) {
                this.originalCanvas.style.display = '';
            }

            this.canvas = null;
            this.originalCanvas = null;
            this.controlsContainer = null;
            this.imageElement = null;
            this.filterSelect = null;
            this.texture = null;
            this.filters = null;
            this.currentFilterValues = null;
        }

        handleFilterChange(e) {
            this.selectedFilter = e.target.value;
            this.updateControls();
            this.applyFilters();
        }

        setupEvents() {
            this.filterSelect.addEventListener('change', this.handleFilterChange);
        }

        updateControls() {
            if (!this.controlsContainer) return;
            this.controlsContainer.innerHTML = '';
            const controls = this.filters[this.selectedFilter] || [];
            this.currentFilterValues = {};

            controls.forEach(control => {
                this.currentFilterValues[control.prop] = control.value;
                const div = document.createElement('div');
                div.className = 'editorimgz-filter';
                const label = document.createElement('label');
                const valueSpan = document.createElement('span');
                valueSpan.textContent = control.value;
                label.textContent = `${control.name}: `;
                label.appendChild(valueSpan);
                const input = document.createElement('input');
                input.type = 'range';
                input.min = control.min;
                input.max = control.max;
                input.value = control.value;
                input.step = control.step;
                input.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    this.currentFilterValues[control.prop] = value;
                    valueSpan.textContent = value.toFixed(2);
                    this.applyFilters();
                });
                div.appendChild(label);
                div.appendChild(input);
                this.controlsContainer.appendChild(div);
            });
        }

        applyFilters() {
            if (!this.canvas) return;
            this.canvas.draw(this.texture);
            if (this.selectedFilter === 'original') {
                this.canvas.update();
                return;
            }
            const v = this.currentFilterValues;
            const w = this.canvas.width;
            const h = this.canvas.height;
            switch (this.selectedFilter) {
                case 'Brightness / Contrast': this.canvas.brightnessContrast(v.brightness, v.contrast); break;
                case 'Hue / Saturation': this.canvas.hueSaturation(v.hue, v.saturation); break;
                case 'Vibrance': this.canvas.vibrance(v.amount); break;
                case 'Denoise': this.canvas.denoise(v.exponent); break;
                case 'Unsharp Mask': this.canvas.unsharpMask(v.radius, v.strength); break;
                case 'Noise': this.canvas.noise(v.amount); break;
                case 'Sepia': this.canvas.sepia(v.amount); break;
                case 'Vignette': this.canvas.vignette(v.size, v.amount); break;
                case 'Zoom Blur': this.canvas.zoomBlur(w / 2, h / 2, v.strength); break;
                case 'Triangle Blur': this.canvas.triangleBlur(v.radius); break;
                case 'Tilt Shift': this.canvas.tiltShift(w / 2, h, w / 2, h / 2, v.blurRadius, v.gradientRadius); break;
                case 'Lens Blur': this.canvas.lensBlur(v.radius, v.brightness, v.angle); break;
                case 'Swirl': this.canvas.swirl(w / 2, h / 2, v.radius, v.angle); break;
                case 'Bulge / Pinch': this.canvas.bulgePinch(w / 2, h / 2, v.radius, v.strength); break;
                case 'Perspective': this.canvas.perspective([v.x1, v.y1, v.x2, v.y2, v.x3, v.y3, v.x4, v.y4], [0, 0, w, 0, 0, h, w, h]); break;
                case 'Ink': this.canvas.ink(v.strength); break;
                case 'Edge Work': this.canvas.edgeWork(v.radius); break;
                case 'Hexagonal Pixelate': this.canvas.hexagonalPixelate(w / 2, h / 2, v.scale); break;
                case 'Dot Screen': this.canvas.dotScreen(w / 2, h / 2, v.angle, v.size); break;
                case 'Color Halftone': this.canvas.colorHalftone(w / 2, h / 2, v.angle, v.size); break;
            }
            this.canvas.update();
        }

        invertColors() {
            this.canvas.draw(this.texture)
                .curves([0, 1], [1, 0], [0, 1], [1, 0], [0, 1], [1, 0])
                .update();
            this.resetFilterSelect();
        }

        flip(axis) {
            const w = this.canvas.width;
            const h = this.canvas.height;
            const before = [0, 0, w, 0, 0, h, w, h];
            let after;
            if (axis === 'x') {
                after = [w, 0, 0, 0, w, h, 0, h];
            } else {
                after = [0, h, w, h, 0, 0, w, 0];
            }
            this.canvas.draw(this.texture)
                .perspective(before, after)
                .update();
            this.resetFilterSelect();
        }

        resetFilterSelect() {
            this.filterSelect.selectedIndex = 0;
            this.selectedFilter = '';
            this.updateControls();
        }
    }

    showLoader(text = 'Procesando...') {
        const loader = document.getElementById('editorimgz-loader');
        loader.textContent = text;
        loader.style.display = 'flex';
    }

    hideLoader() {
        document.getElementById('editorimgz-loader').style.display = 'none';
    }

    loadImageFromFile(file) {
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const image = document.getElementById('editorimgz-image');
            image.src = e.target.result;
            console.log('image loadImageFromFile');
        };
        reader.readAsDataURL(file);
    }

    async processUpscale(scale) {
        this.showLoader(`Mejorando escala ${scale}x...`);
        try {
            const image = document.getElementById('editorimgz-image');
            const result = await this.upscaler.upscale(image, { scale });
            image.src = result;
        } catch (err) {
            console.error('Error during upscale:', err);
        } finally {
            this.hideLoader();
        }
    }

    async removeBackground() {
        this.showLoader('Eliminando fondo...');
        try {
            const image = document.getElementById('editorimgz-image');
            const blob = await this.backgroundRemoval(image.src);
            this.loadImageFromFile(blob);
        } catch (err) {
            console.error('Error removing background:', err);
        } finally {
            this.hideLoader();
        }
    }

    async quadrupleImage() {
        this.showLoader('Cuadruplicando imagen...');
        await new Promise(resolve => setTimeout(resolve, 10));

        const img = document.getElementById('editorimgz-image');
        const tempCanvas = document.createElement('canvas');
        const w = img.naturalWidth;
        const h = img.naturalHeight;

        tempCanvas.width = w * 2;
        tempCanvas.height = h * 2;
        const ctx = tempCanvas.getContext('2d');

        ctx.drawImage(img, 0, 0);

        ctx.save();
        ctx.translate(w * 2, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(img, 0, 0);
        ctx.restore();

        ctx.save();
        ctx.translate(0, h * 2);
        ctx.scale(1, -1);
        ctx.drawImage(img, 0, 0);
        ctx.restore();

        ctx.save();
        ctx.translate(w * 2, h * 2);
        ctx.scale(-1, -1);
        ctx.drawImage(img, 0, 0);
        ctx.restore();

        img.src = tempCanvas.toDataURL();
        this.hideLoader();
    }
}
    </script>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
            background-color: #f0f0f0;
        }

        #menusimple {
            position: fixed;
            top: 50%;
            left: 0%;
            transform: translate(0%, -50%);
            height: auto;
            min-height: 400px;
            width: 67px;
             
            border-right: 1.5px solid #e5e5e0;
            box-shadow: 4px 2px 10px 3px rgba(0, 0, 0, 0.23);
            background-color: #41414162;
            z-index: 10;

     display: flex;
	flex-direction: column;
	flex-wrap: nowrap;
	justify-content: center;
	align-items: center;
	align-content: flex-start;
        }
        #menusimple *{
            margin-top: 2px;
            margin-bottom: 2px;
        }
       

        #contenedor {
            width: 86%;
            height: 94%;
            position: fixed;
            top: 80px;
            left: 10%;
            background-color: rgb(255, 255, 255);
            overflow-y: scroll;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
            padding: 20px;
            box-sizing: border-box;
        }

        .contenedordeiamgenes {
            background-color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .imgcontenida {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .contenedordeiamgenes:hover .imgcontenida {
            transform: scale(1.05);
        }
        
        .info-imagen {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px;
            box-sizing: border-box;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            text-align: center;
        }

        .contenedordeiamgenes:hover .info-imagen {
            transform: translateY(0);
        }

        .info-imagen h4 {
            margin: 0;
            font-size: 1em;
        }

        .repo-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.226);
            color: rgba(255, 255, 255, 0.247);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }

        #controlesPaginacion {
            position: fixed;
            bottom: 4%;
            left: 53%;
            transform: translateX(-50%);
            text-align: center;
            width: 86%;
        }

        #controlesPaginacion button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 0 10px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #efefef;
        }

        #controlesPaginacion button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            background-color: #f0f0f0;
        }

        #cargando {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 1000;
        }

        .error {
            background-color: white;
            color: black;
            padding: 20px;
            border: 1px solid #ccc;
            margin: 20px;
            text-align: center;
            max-width: 600px;
            margin: 20px auto;
        }
        
        .error h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .error p {
            margin: 10px 0;
            line-height: 1.4;
        }

        #idcontendoreditor{
            position: fixed;
            width: 100%;
            height: 100%;
            background-color: #ffffffc9;
            z-index: 100000;
            display: none;
            flex-direction: column;
            flex-wrap: nowrap;
            justify-content: center;
            align-items: center;
            align-content: center;
            padding-bottom: 70px;
        }
     
        .clbtsimpleeditors{
            border: none;
            background-color: #525252;
            color: #ffffff;
            width: auto;
            min-width: 60px;
            height: 60px;
            border-radius: 50%;
        }

        #dicloseedit{
            position: fixed;
            top: 10%;
            right: 20%;
            z-index: 1000000;
        }

        .info-paginacion {
            display: inline-block;
            margin: 0 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            font-size: 14px;
        }

        #vista-previa-hover {
            position: fixed;
            width: 700px;
            height: 700px;
            background: white;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            z-index: 5000;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            overflow: hidden;
        }

        #vista-previa-hover.visible {
            opacity: 1;
            transform: scale(1);
        }

        #vista-previa-hover img {
            width: 100%;
            height: 90%;
            object-fit: contain;
        }

        #vista-previa-hover .info-preview {
            height: 10%;
            padding: 10px;
            background: #333;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
        }

        #repo-stats {
            display: none;
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
        }

        @media only screen and (max-width: 400px) {
 
#contenedor{
    position: fixed;
    top: 0%;
    left: 70px;
    width: 100%;
    height: 100%;

}
.contenedordeiamgenes{
    width: 400px;
    height: 400px; 
    display: flex;
	flex-direction: row;
	flex-wrap: nowrap;
	justify-content: center;
	align-items: center;
	align-content: center;
}

.displanone{
    display: none;
}

 
}
body{
    background-color: #ffffff;
}
/* @media only screen and (max-width: 350px) {
  body {
    background-color: red;
  }
} */


.cbtondeimgsimple{
    border: none;
    background-color: #4d4d4d;

    color: #c7c7c7;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 13px;
     display: flex;
	flex-direction: row;
	flex-wrap: nowrap;
	justify-content: center;
	align-items: center;
	align-content: center;
    cursor: pointer;
    transition: 0.7s;

}
.cbtondeimgsimple:hover{

    color: #ffffff;
    background-color: #8f8f8f;
    scale: 1.2;
   

}
.displanone{
 
}

 
    </style>
</head>
<body>
    <div id="idbotonmensumple"></div>
    <div id="repo-stats"></div>
    <div id="idcontendoreditor"><button id="dicloseedit" class="clbtsimpleeditors">close</button></div>

    <div id="vista-previa-hover">
        <img id="preview-img" src="" alt="">
        <div class="info-preview" id="preview-info"></div>
    </div>

    <div id="menusimple">
        <button class="cbtondeimgsimple"  id="btnSiguientebt">-></button>
    <button class="cbtondeimgsimple" id="btnAtrasbt"  ><-</button>
      <button class="cbtondeimgsimple" id="btnRecargarbt"  ><-></button>
      <button class="cbtondeimgsimple" id="btneditorIni"  >imgG</button>
</div>
    <div id="contenedor"></div>
    <div id="controlesPaginacion" style="display: none;">
        <button id="btnAtras" class="displanone">Atrs</button>
        <button id="btnSiguiente" class="displanone">Siguiente</button>
        <button id="btnRecargar" class="displanone">Recargar</button>
    </div>

    <div id="cargando" style="display: none;">
        <p>load ...</p>
    </div>

    <script  >
        document.addEventListener('DOMContentLoaded', () => {
            const contenedor = document.getElementById('contenedor');
            const btnAtras = document.getElementById('btnAtras');
            const btnSiguiente = document.getElementById('btnSiguiente');
            const btnRecargar = document.getElementById('btnRecargar');
            const cargando = document.getElementById('cargando');
            const repoStats = document.getElementById('repo-stats');

            const btdicloseedit=document.getElementById("dicloseedit");
            btdicloseedit.onclick=()=>{ document.getElementById("idcontendoreditor").style.display="none";}
            
            const vistaPrevia = document.getElementById('vista-previa-hover');
            const previewImg = document.getElementById('preview-img');
            const previewInfo = document.getElementById('preview-info');
            
            var editorgiofilter=null;
            let todasLasUrls = []; 
            let loteActual = 0;  
            const imagenesPorLote = 30;  

            const repositorios = [
         { owner: 'unonibes4a', name: 'newImgs' }, 
                { owner: 'unonibes4a', name: 'newimg2' },
              
            ];

            const extensionesValidas = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg', '.tiff', '.tif', '.ico'];

            function esImagen(nombreArchivo) {
                const extension = nombreArchivo.toLowerCase().substring(nombreArchivo.lastIndexOf('.'));
                return extensionesValidas.includes(extension);
            }
          
            function obtenerNombreArchivo(path) {
                return path.split('/').pop().replace(/\.[^/.]+$/, "");
            }

            function mostraridcontendoreditor(){
                document.getElementById("idcontendoreditor").style.display="flex";
            }

            function posicionarVistaPrevia(mouseX, mouseY, elementoRect) {
                const previewWidth = 500;
                const previewHeight = 500;
                const margen = 20;
                
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                
                let x, y;
                
                if (mouseX < windowWidth / 2) {
                    x = elementoRect.right + margen;
                    if (x + previewWidth > windowWidth) {
                        x = windowWidth - previewWidth - margen;
                    }
                } else {
                    x = elementoRect.left - previewWidth - margen;
                    if (x < 0) {
                        x = margen;
                    }
                }
                
                y = mouseY - previewHeight / 2;
                
                if (y < margen) {
                    y = margen;
                } else if (y + previewHeight > windowHeight - margen) {
                    y = windowHeight - previewHeight - margen;
                }
                
                vistaPrevia.style.left = x + 'px';
                vistaPrevia.style.top = y + 'px';
            }

            function mostrarVistaPrevia(imgSrc, nombre, mouseEvent, elemento) {
                previewImg.src = imgSrc;
                previewInfo.textContent = nombre;
                
                const rect = elemento.getBoundingClientRect();
                posicionarVistaPrevia(mouseEvent.clientX, mouseEvent.clientY, rect);
                
                elemento.classList.add('hover-active');
                vistaPrevia.classList.add('visible');
            }

            function ocultarVistaPrevia(elemento) {
                elemento.classList.remove('hover-active');
                vistaPrevia.classList.remove('visible');
            }

            async function cargarImagenesDesdeDirectorio(url, rutaBase = '', repoName = '') {
                const urls = [];
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.warn(`Error al cargar directorio ${url}: ${response.status}`);
                        return urls;
                    }

                    const data = await response.json();
                    
                    for (const item of data) {
                        if (item.type === 'file' && esImagen(item.name)) {
                            urls.push({
                                url: item.download_url,
                                nombre: obtenerNombreArchivo(item.name),
                                repo: repoName
                            });
                        } else if (item.type === 'dir') {
                            const subUrls = await cargarImagenesDesdeDirectorio(
                                item.url, 
                                `${rutaBase}${item.name}/`,
                                repoName
                            );
                            urls.push(...subUrls);
                        }
                    }
                } catch (error) {
                    console.warn(`Error procesando directorio ${url}:`, error);
                }
                return urls;
            }

            async function cargarImagenesDesdeRepositorio(repo) {
                const githubApiUrl = `https://api.github.com/repos/${repo.owner}/${repo.name}/contents`;
                console.log(`Cargando desde repositorio: ${repo.name}`);
                
                try {
                    const urls = await cargarImagenesDesdeDirectorio(githubApiUrl, '', repo.name);
                    console.log(`${repo.name}: ${urls.length} imgenes encontradas`);
                    return urls;
                } catch (error) {
                    console.warn(`Error cargando repositorio ${repo.name}:`, error);
                    return [];
                }
            }

            async function cargarImagenesDesdeMultiplesRepos() {
                cargando.style.display = 'block';
                
                try {
                    console.log(`Cargando desde ${repositorios.length} repositorios...`);
                    
                    const promesas = repositorios.map(repo => cargarImagenesDesdeRepositorio(repo));
                    const resultados = await Promise.all(promesas);
                    
                    const todasLasImagenes = resultados.flat();
                    
                    console.log(`Total de imgenes encontradas: ${todasLasImagenes.length}`);
                    
                    const estadisticas = {};
                    todasLasImagenes.forEach(img => {
                        estadisticas[img.repo] = (estadisticas[img.repo] || 0) + 1;
                    });
                    
                    let statsText = `Total: ${todasLasImagenes.length} | `;
                    for (const [repo, count] of Object.entries(estadisticas)) {
                        statsText += `${repo}: ${count} | `;
                    }
                    repoStats.textContent = statsText.slice(0, -3);
                    
                    if (todasLasImagenes.length === 0) {
                        throw new Error('No se encontraron imgenes en ningn repositorio.');
                    }

                    const urlsBarajadas = barajarArray([...todasLasImagenes]);
                    console.log('URLs combinadas y barajadas, listas para mostrar en lotes de', imagenesPorLote);

                    return urlsBarajadas;

                } catch (error) {
                    console.error('Error cargando imgenes desde repositorios:', error);
                    contenedor.innerHTML = `
                        <div class="error">
                            <h3>Error cargando imgenes</h3>
                            <p>No se pudieron cargar las imgenes de los repositorios</p>
                            <p>${error.message}</p>
                        </div>
                    `;
                    return [];
                } finally {
                    cargando.style.display = 'none';
                }
            }

            function barajarArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function obtenerLoteActual() {
                const inicio = loteActual * imagenesPorLote;
                const fin = inicio + imagenesPorLote;
                return todasLasUrls.slice(inicio, fin);
            }

            function actualizarBotones() {
                const totalLotes = Math.ceil(todasLasUrls.length / imagenesPorLote);
                
                btnAtras.disabled = (loteActual === 0);
                document.getElementById("btnAtrasbt").disabled= (loteActual === 0);
                btnSiguiente.disabled = (loteActual >= totalLotes - 1);
                
                console.log(`Lote actual: ${loteActual + 1} de ${totalLotes}`);
            }

            function generarNumeroAleatorio(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            function mostrarLote() {
                const imagenes = obtenerLoteActual();
                
                contenedor.innerHTML = '';
                
                if (imagenes.length === 0) {
                    contenedor.innerHTML = '<div class="error">No hay imgenes para mostrar en este lote</div>';
                    return;
                }

                const fragmento = document.createDocumentFragment();

                imagenes.forEach(imageData => {
                    const divContenedor = document.createElement('div');
                    divContenedor.className = 'contenedordeiamgenes';
                   
                    let w = 223;
                    let h = generarNumeroAleatorio(200, 400);
                      if(window.innerWidth>=410){
     divContenedor.style.width = w.toString() + "px";
                    divContenedor.style.height = h.toString() + "px";
                    }
                    else{
                        w = 290;
                     // h = generarNumeroAleatorio(200, 400); 
                     divContenedor.style.width = w.toString() + "px";
                    divContenedor.style.height = h.toString() + "px";  
                        
                    }
                

                    const imgElemento = document.createElement('img');
                    imgElemento.className = 'imgcontenida';
                    imgElemento.src = imageData.url;
                    imgElemento.alt = imageData.nombre;
                    
                    imgElemento.onclick = () => {
                        window.appEditorgioBasico.setImage(imgElemento.src);
                      /*   if (editorgiofilter) {
                            editorgiofilter.changeImgUrl(imgElemento.src);
                            mostraridcontendoreditor();
                        } */
                       calleditorpintaresta();
                    }
                    
                    divContenedor.onmouseenter = (e) => {
                        mostrarVistaPrevia(imageData.url, `${imageData.nombre} (${imageData.repo})`, e, divContenedor);
                    };
                    
                    divContenedor.onmouseleave = () => {
                        ocultarVistaPrevia(divContenedor);
                    };
                    
                    divContenedor.onmousemove = (e) => {
                        if (vistaPrevia.classList.contains('visible')) {
                            const rect = divContenedor.getBoundingClientRect();
                            posicionarVistaPrevia(e.clientX, e.clientY, rect);
                        }
                    };
                    
                    imgElemento.onerror = function() {
                        this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="240" height="340" viewBox="0 0 240 340"%3E%3Crect width="240" height="340" fill="%23f0f0f0"/%3E%3Ctext x="120" y="170" text-anchor="middle" fill="%23999" font-family="Arial, sans-serif" font-size="14"%3EImagen no disponible%3C/text%3E%3C/svg%3E';
                    };

                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'info-imagen';
                    infoDiv.innerHTML = `<h4>${imageData.nombre}</h4>`;

                    const repoBadge = document.createElement('div');
                    repoBadge.className = 'repo-badge';
                    repoBadge.textContent = imageData.repo;  

                    divContenedor.appendChild(imgElemento);
                    divContenedor.appendChild(infoDiv);
                    divContenedor.appendChild(repoBadge);  
                    fragmento.appendChild(divContenedor);
                });

                contenedor.appendChild(fragmento);
                actualizarBotones();
            }

            btnAtras.addEventListener('click', () => {
                if (loteActual > 0) {
                    loteActual--;
                    mostrarLote();
                   
                }
            });
             document.getElementById("btnAtrasbt").addEventListener('click', () => {
                if (loteActual > 0) {
                    loteActual--;
                    mostrarLote();
                 
                }
            });

            btnSiguiente.addEventListener('click', () => {
                const totalLotes = Math.ceil(todasLasUrls.length / imagenesPorLote);
                if (loteActual < totalLotes - 1) {
                    loteActual++;
                    mostrarLote();
                    
                }
            });
          document.getElementById("btnSiguientebt").onclick=()=>{
              const totalLotes = Math.ceil(todasLasUrls.length / imagenesPorLote);
                if (loteActual < totalLotes - 1) {
                    loteActual++;
                    mostrarLote();
                  
                }

          }; 

           
              document.getElementById("btneditorIni").onclick=()=>{
                calleditorpintaresta();
                          
         };


function calleditorpintaresta(){
  const soporteApp = document.getElementById('idSoporteApp');  
        soporteApp.style.display = soporteApp.style.display === 'none' ? 'block' : 'none';  
}


           document.getElementById("btnRecargarbt").onclick=()=>{
                  iniciarGaleria();
         };
            btnRecargar.addEventListener('click', () => {
                iniciarGaleria();
            });

            async function iniciarGaleria() {
                const urls = await cargarImagenesDesdeMultiplesRepos();
                
                if (urls.length > 0) {
                    todasLasUrls = urls;  
                    loteActual = 0;  
                    mostrarLote();
                    
                    const totalLotes = Math.ceil(todasLasUrls.length / imagenesPorLote);
                    console.log(`Galera iniciada: ${todasLasUrls.length} imgenes en ${totalLotes} lotes de ${imagenesPorLote}`);
                }
            }

            function inifiltergio(){
                try {
                    editorgiofilter = new EditorImgz('idcontendoreditor');
                } catch (error) {
                    console.warn('Editor de imgenes no disponible:', error);
                }
            }
            
            inifiltergio();
            iniciarGaleria();
        });
    </script>

</body>
</html>





